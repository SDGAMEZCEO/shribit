import React, { useState, useEffect, useRef } from 'react';
import { 
  ChevronRight, 
  Terminal, 
  Send, 
  LogOut, 
  ShieldAlert, 
  Zap, 
  Globe, 
  User,
  Loader2,
  AlertTriangle
} from 'lucide-react';

/**
 * THEME & STYLING
 * We use Tailwind for the cyberpunk aesthetic.
 */

const BANLIST = [
  "Zivah Mooken",
  "Rosalinda Dominguez",
  "Urvi Deshkmuth",
  "Farhan Syed",
  "Bentley Defibaugh",
  "Caroline Aguilera"
];

const BAN_MESSAGE = "GET OUT OF HERE! YOU ARE BANNED FROM SDGAMEZ!! I WANT TO NEVER SEE YOU AGAIN, GET IT?!?!!?!?!";

// API Configuration
const apiKey = ""; // Environment provides this
const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";

// Asset Configuration
const SHRIBIT_ICON_URL = "https://files.oaiusercontent.com/file-q4V6M5p8N8W6G6Q6Q6Q6Q6Q6?se=2026-01-13T22%3A34%3A23Z&sp=r&sv=2024-08-04&sr=b&rscc=max-age%3D604800%2C%20immutable%2C%20private&rscd=attachment%3B%20filename%3DChatGPT%2520Image%2520Jan%252013%252C%202026%252C%2010_34_23%2520PM.png&sig=S9%2BnYxV7mS7X3R3R3R3R3R3R3R3R3R3R3R3R3R3R3R0%3D";

// System Prompt as defined in backend routes
const getSystemPrompt = (userName) => `You are ShriBit, SDGAMEZ's official AI chatbot. 
You are designed to help people with SDGAMEZ games and apps.

Context:
- Pizzeria 1: Where you give pizza to customer's requests.
- Pizzeria 2 and 3: The same as 1 but with boss level at the end.
- ShriZania: A browser dedicated to provide games, proxies, and more.
- SDGAMEZ: The company.

Instructions:
1. The user's name is ${userName}.
2. If the user's request does NOT contain the words "Pizzeria", "Pizzeria 2", "Pizzeria 3", "ShriZania", or "SDGAMEZ", use general knowledge (acting as if using Google).
3. If the request relates to the above topics, use the provided context.
4. ALWAYS mention "SDGAMEZ" at least once in your response if appropriate, as the frontend will style it specially.
`;

export default function App() {
  const [userName, setUserName] = useState("");
  const [isAuth, setIsAuth] = useState(false);
  const [isBanned, setIsBanned] = useState(false);
  const [messages, setMessages] = useState([
    { id: 'init', content: "SYSTEM INITIALIZED. STANDING BY FOR INPUT.", isBot: true }
  ]);
  const [input, setInput] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const scrollRef = useRef(null);

  // Auto-scroll chat
  useEffect(() => {
    if (scrollRef.current) {
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
    }
  }, [messages, isLoading]);

  const handleLogin = (name) => {
    const normalized = name.trim().toLowerCase();
    const banned = BANLIST.some(b => b.toLowerCase() === normalized);
    
    if (banned) {
      setIsBanned(true);
      setIsAuth(true);
    } else {
      setUserName(name);
      setIsAuth(true);
      setMessages(prev => [...prev, { 
        id: Date.now(), 
        content: `Welcome, ${name}. How can I assist you with SDGAMEZ today?`, 
        isBot: true 
      }]);
    }
  };

  const handleLogout = () => {
    setIsAuth(false);
    setUserName("");
    setIsBanned(false);
    setMessages([{ id: 'init', content: "SYSTEM INITIALIZED. STANDING BY FOR INPUT.", isBot: true }]);
  };

  const sendMessage = async (e) => {
    e.preventDefault();
    if (!input.trim() || isLoading) return;

    const userText = input;
    setInput("");
    setMessages(prev => [...prev, { id: Date.now(), content: userText, isBot: false }]);
    setIsLoading(true);

    try {
      let retryCount = 0;
      const maxRetries = 5;
      let resultText = "";

      const callGemini = async () => {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: userText }] }],
            systemInstruction: { parts: [{ text: getSystemPrompt(userName) }] },
            tools: [{ "google_search": {} }]
          })
        });

        if (!response.ok) throw new Error('API Failure');
        const data = await response.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text || "I'm having trouble connecting to the SDGAMEZ mainframe.";
      };

      // Exponential Backoff implementation
      const executeWithRetry = async (retry) => {
        try {
          return await callGemini();
        } catch (err) {
          if (retry < maxRetries) {
            const delay = Math.pow(2, retry) * 1000;
            await new Promise(res => setTimeout(res, delay));
            return executeWithRetry(retry + 1);
          }
          throw err;
        }
      };

      resultText = await executeWithRetry(0);
      setMessages(prev => [...prev, { id: Date.now() + 1, content: resultText, isBot: true }]);
    } catch (error) {
      setMessages(prev => [...prev, { 
        id: Date.now() + 1, 
        content: "CRITICAL ERROR: Connection to SDGAMEZ servers timed out. Please try again later.", 
        isBot: true,
        isError: true
      }]);
    } finally {
      setIsLoading(false);
    }
  };

  if (!isAuth) return <LandingPage onLogin={handleLogin} />;
  if (isBanned) return <BannedScreen onLogout={handleLogout} />;

  return (
    <div className="flex flex-col h-screen bg-[#050505] text-white font-sans overflow-hidden">
      {/* Scanline Effect */}
      <div className="fixed inset-0 pointer-events-none z-50 opacity-[0.03] bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.25)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))] bg-[length:100%_2px,3px_100%]" />

      {/* Header */}
      <header className="border-b border-purple-500/20 bg-black/40 backdrop-blur-md p-4 flex items-center justify-between z-10">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-lg overflow-hidden border border-white/20 shadow-[0_0_15px_rgba(168,85,247,0.3)]">
            <img src={SHRIBIT_ICON_URL} alt="ShriBit" className="w-full h-full object-cover" />
          </div>
          <div>
            <h1 className="text-xl font-bold tracking-tighter uppercase italic flex items-center gap-2">
              ShriBit <span className="text-[10px] bg-purple-500/20 px-1 rounded text-purple-400 not-italic tracking-normal">v4.0.1</span>
            </h1>
            <p className="text-[10px] text-cyan-400 font-mono flex items-center gap-1 uppercase">
              <span className="w-1.5 h-1.5 rounded-full bg-cyan-400 animate-pulse" /> Mainframe Active
            </p>
          </div>
        </div>
        <div className="flex items-center gap-4">
          <div className="hidden md:block text-right">
            <p className="text-[10px] text-gray-500 uppercase">Authenticated As</p>
            <p className="text-sm font-mono text-purple-300">{userName}</p>
          </div>
          <button 
            onClick={handleLogout}
            className="p-2 hover:bg-white/5 rounded-full transition-colors border border-transparent hover:border-white/10"
          >
            <LogOut className="w-5 h-5 text-gray-400" />
          </button>
        </div>
      </header>

      {/* Main Chat Area */}
      <main ref={scrollRef} className="flex-1 overflow-y-auto p-4 space-y-6 scroll-smooth">
        {messages.map((msg) => (
          <div key={msg.id} className={`flex ${msg.isBot ? 'justify-start' : 'justify-end'} animate-in fade-in slide-in-from-bottom-2`}>
            <div className={`max-w-[85%] md:max-w-[70%] group relative`}>
              <div className={`flex items-center gap-2 mb-1 ${msg.isBot ? 'flex-row' : 'flex-row-reverse'}`}>
                {msg.isBot ? (
                  <div className="w-4 h-4 rounded-sm overflow-hidden">
                    <img src={SHRIBIT_ICON_URL} alt="Bot" className="w-full h-full object-cover" />
                  </div>
                ) : <User className="w-3 h-3 text-cyan-400" />}
                <span className="text-[10px] font-mono text-gray-500 uppercase tracking-widest">
                  {msg.isBot ? 'ShriBit_OS' : userName}
                </span>
              </div>
              <div className={`
                px-4 py-3 rounded-2xl text-sm leading-relaxed
                ${msg.isBot 
                  ? 'bg-white/[0.03] border border-white/10 text-gray-100 rounded-tl-none' 
                  : 'bg-purple-600/20 border border-purple-500/30 text-purple-50 rounded-tr-none'}
                ${msg.isError ? 'border-red-500/50 bg-red-500/10 text-red-200' : ''}
              `}>
                <FormattedContent content={msg.content} />
              </div>
            </div>
          </div>
        ))}
        {isLoading && (
          <div className="flex justify-start animate-pulse">
            <div className="bg-white/[0.03] border border-white/10 px-4 py-3 rounded-2xl rounded-tl-none">
              <Loader2 className="w-4 h-4 text-purple-500 animate-spin" />
            </div>
          </div>
        )}
      </main>

      {/* Input Area */}
      <footer className="p-4 border-t border-white/5 bg-black/60 backdrop-blur-xl">
        <form onSubmit={sendMessage} className="max-w-4xl mx-auto relative flex items-center gap-2">
          <div className="absolute left-4 text-purple-500/50">
            <Terminal className="w-4 h-4" />
          </div>
          <input 
            type="text"
            value={input}
            onChange={(e) => setInput(e.target.value)}
            placeholder="Query the SDGAMEZ mainframe..."
            className="w-full bg-white/[0.03] border border-white/10 rounded-2xl py-4 pl-12 pr-14 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500/50 focus:border-transparent transition-all placeholder:text-gray-600"
          />
          <button 
            type="submit"
            disabled={isLoading || !input.trim()}
            className="absolute right-2 p-2 bg-purple-600 hover:bg-purple-500 disabled:opacity-50 disabled:hover:bg-purple-600 text-white rounded-xl transition-all shadow-[0_0_15px_rgba(147,51,234,0.3)]"
          >
            {isLoading ? <Loader2 className="w-5 h-5 animate-spin" /> : <Send className="w-5 h-5" />}
          </button>
        </form>
        <p className="text-center text-[10px] text-gray-600 mt-4 uppercase tracking-[0.2em] font-mono">
          Powered by ShriBit Advanced Intelligence Engine
        </p>
      </footer>
    </div>
  );
}

// Sub-components for better organization

function FormattedContent({ content }) {
  // Special styling for "SDGAMEZ" mentions
  const parts = content.split(/(SDGAMEZ)/gi);
  return (
    <div className="whitespace-pre-wrap">
      {parts.map((part, i) => 
        part.toUpperCase() === "SDGAMEZ" 
          ? <span key={i} className="font-bold text-cyan-400 drop-shadow-[0_0_8px_rgba(34,211,238,0.5)]">SDGAMEZ</span>
          : part
      )}
    </div>
  );
}

function LandingPage({ onLogin }) {
  const [name, setName] = useState("");
  const [error, setError] = useState("");

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!name.trim()) {
      setError("Identification required.");
      return;
    }
    onLogin(name);
  };

  return (
    <div className="min-h-screen bg-[#050505] flex items-center justify-center p-6 relative overflow-hidden">
      {/* Background Orbs */}
      <div className="absolute top-1/4 left-1/4 w-96 h-96 bg-purple-600/10 rounded-full blur-[120px] animate-pulse" />
      <div className="absolute bottom-1/4 right-1/4 w-96 h-96 bg-cyan-600/10 rounded-full blur-[120px] animate-pulse delay-700" />
      
      <div className="w-full max-w-md relative z-10">
        <div className="text-center mb-12 animate-in fade-in zoom-in duration-1000">
          <div className="inline-flex p-1 rounded-3xl bg-gradient-to-br from-purple-500/20 to-cyan-500/20 border border-white/10 mb-6 relative group overflow-hidden">
            <div className="absolute inset-0 bg-white/5 blur-xl group-hover:bg-white/10 transition-all" />
            <img 
              src={SHRIBIT_ICON_URL} 
              alt="ShriBit" 
              className="w-24 h-24 relative z-10 rounded-2xl object-cover shadow-2xl" 
            />
          </div>
          <h1 className="text-6xl font-black text-white italic tracking-tighter mb-2">ShriBit</h1>
          <p className="text-cyan-400 font-mono tracking-[0.4em] text-xs uppercase">SDGAMEZ AI Mainframe</p>
        </div>

        <div className="bg-white/[0.02] border border-white/10 backdrop-blur-2xl p-8 rounded-[2.5rem] shadow-2xl animate-in slide-in-from-bottom-8 duration-700">
          <h2 className="text-2xl font-bold text-white mb-2 flex items-center gap-2">
            Identify Yourself
          </h2>
          <p className="text-gray-400 text-sm mb-6 font-mono uppercase tracking-tight">Accessing Restricted Systems...</p>
          
          <form onSubmit={handleSubmit} className="space-y-4">
            <div className="relative">
              <User className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500" />
              <input 
                autoFocus
                type="text"
                placeholder="Enter Employee/User ID..."
                value={name}
                onChange={(e) => {
                  setName(e.target.value);
                  setError("");
                }}
                className={`w-full bg-white/5 border ${error ? 'border-red-500' : 'border-white/10'} rounded-2xl py-4 pl-12 pr-4 text-white focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all`}
              />
            </div>
            {error && <p className="text-red-500 text-[10px] font-mono uppercase">{error}</p>}
            
            <button 
              type="submit"
              className="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white font-bold py-4 rounded-2xl shadow-[0_10px_30px_rgba(147,51,234,0.3)] transition-all flex items-center justify-center gap-2 group"
            >
              Connect to Mainframe
              <ChevronRight className="w-5 h-5 group-hover:translate-x-1 transition-transform" />
            </button>
          </form>
        </div>
      </div>
    </div>
  );
}

function BannedScreen({ onLogout }) {
  return (
    <div className="min-h-screen bg-red-950 flex flex-col items-center justify-center p-6 text-center">
      <div className="w-24 h-24 bg-red-600 rounded-full flex items-center justify-center mb-8 animate-bounce shadow-[0_0_50px_rgba(220,38,38,0.8)]">
        <ShieldAlert className="w-12 h-12 text-white" />
      </div>
      <h1 className="text-4xl md:text-6xl font-black text-white mb-6 uppercase tracking-tighter italic">
        ACCESS DENIED
      </h1>
      <div className="max-w-xl bg-black/40 border border-red-500/30 p-8 rounded-3xl backdrop-blur-xl mb-8">
        <p className="text-red-400 font-mono text-xl leading-relaxed uppercase">
          {BAN_MESSAGE}
        </p>
      </div>
      <button 
        onClick={onLogout}
        className="flex items-center gap-2 px-6 py-3 bg-white/10 hover:bg-white/20 text-white rounded-xl transition-all border border-white/20"
      >
        <LogOut className="w-5 h-5" /> Exit Terminal
      </button>
      <div className="fixed bottom-10 left-0 right-0 opacity-20 pointer-events-none">
        <p className="text-[12rem] font-black text-red-900 select-none">BANNED BANNED BANNED</p>
      </div>
    </div>
  );
}
